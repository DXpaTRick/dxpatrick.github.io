<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apex Fusion v1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rpg-bg': '#1a1a1a',
                        'rpg-card': '#2c2c2c',
                        'rpg-accent': '#ff4500',
                        'rpg-accent-hover': '#e03e00',
                        'rpg-text': '#f0f0f0',
                        'rpg-subtext': '#a0a0a0',
                        'rpg-border': '#444444',
                        'rpg-progress-bg': '#444444',
                        'rpg-physical': 'rgba(255, 69, 0, 0.7)',
                        'rpg-mental': 'rgba(0, 206, 209, 0.7)',
                        'rpg-streak': '#ffd700',
                        'rpg-modal-bg': 'rgba(0, 0, 0, 0.7)',
                    },
                    fontFamily: {
                      sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        body {
            @apply bg-rpg-bg text-rpg-text font-sans;
        }
        .task-checkbox:checked + label {
            @apply line-through text-rpg-subtext;
        }
        .stat-bar-container {
            @apply mb-4;
        }
        #chartContainer {
             @apply relative h-64 md:h-96;
        }
        .modal {
            @apply fixed inset-0 bg-rpg-modal-bg flex items-center justify-center p-4 z-50 transition-opacity duration-300 ease-in-out;
        }
        .modal-content {
            @apply bg-rpg-card rounded-lg shadow-xl p-6 max-w-sm w-full border border-rpg-border;
        }
        .tooltip {
            @apply relative cursor-pointer;
        }
        .tooltip:hover::after {
            content: attr(data-tooltip);
            @apply absolute bg-gray-900 text-white text-xs rounded py-1 px-2 -top-8 left-1/2 transform -translate-x-1/2 whitespace-nowrap z-10;
        }
        .form-input, .form-select {
             @apply w-full px-3 py-2 bg-gray-700 border border-rpg-border rounded-md text-rpg-text focus:outline-none focus:ring-1 focus:ring-rpg-accent focus:border-rpg-accent text-sm;
        }
        .form-label {
            @apply block text-sm font-medium text-rpg-subtext mb-1;
        }
        .btn {
            @apply py-2 px-4 rounded-lg font-semibold transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-opacity-50 shadow;
        }
        .btn-primary {
            @apply bg-rpg-accent text-white hover:bg-rpg-accent-hover focus:ring-rpg-accent;
        }
         .btn-secondary {
            @apply bg-gray-600 text-rpg-text hover:bg-gray-500 focus:ring-gray-400;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700 focus:ring-red-500;
        }
         .btn-success { /* Yeni buton stili */
            @apply bg-green-600 text-white hover:bg-green-700 focus:ring-green-500;
        }
         .btn-info { /* Yeni buton stili */
            @apply bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500;
        }
    </style>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>

</head>
<body class="antialiased">

    <header class="bg-rpg-card py-4 px-6 text-center shadow-lg">
        <h1 class="text-3xl font-bold text-rpg-accent tracking-wider">Apex Fusion v1</h1>
    </header>

    <main class="container mx-auto p-4 md:p-6 lg:p-8 max-w-6xl">

        <section class="text-center mb-6">
            <div id="g_id_onload"
                 data-client_id="755451034699-ir2d9cjv9ngsckqd14np3citeqnmlrjs.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin"
                 data-type="standard"
                 data-size="large"
                 data-theme="outline"
                 data-text="sign_in_with"
                 data-shape="rectangular"
                 data-logo_alignment="left">
            </div>
             <div id="authStatus" class="mt-2 text-sm text-rpg-subtext">Google Drive bağlantısı bekleniyor...</div>
             <button id="signOutButton" class="btn btn-secondary btn-sm mt-2 hidden">Çıkış Yap</button>
        </section>

        <section class="text-center mb-8 space-x-4">
             <button id="saveToDriveButton" class="btn btn-success" disabled>
                <i class="fas fa-save mr-1"></i> Drive'a Kaydet
            </button>
             <button id="loadFromDriveButton" class="btn btn-info" disabled>
                <i class="fas fa-download mr-1"></i> Drive'dan Yükle
            </button>
        </section>


        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <article class="bg-rpg-card rounded-xl p-5 shadow-md border border-rpg-border">
                <h3 class="text-xl font-semibold mb-4 text-rpg-accent border-b border-rpg-border pb-2">Fiziksel Rutin</h3>
                <div id="physicalTasks" class="space-y-3">
                    <p class="text-rpg-subtext text-sm italic">Yükleniyor...</p>
                </div>
            </article>
            <article class="bg-rpg-card rounded-xl p-5 shadow-md border border-rpg-border">
                <h3 class="text-xl font-semibold mb-4 text-rpg-accent border-b border-rpg-border pb-2">Zihinsel Rutin</h3>
                 <div id="mentalTasks" class="space-y-3">
                     <p class="text-rpg-subtext text-sm italic">Yükleniyor...</p>
                 </div>
            </article>
        </section>

        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <div class="bg-rpg-card rounded-xl p-5 shadow-md text-center border border-rpg-border">
                <h3 class="text-lg font-semibold mb-2 text-rpg-subtext">Görev Tamamlandı</h3>
                <p id="doneCount" class="text-3xl font-bold text-rpg-accent">0 / 0</p>
            </div>
            <div class="bg-rpg-card rounded-xl p-5 shadow-md text-center border border-rpg-border">
                <h3 class="text-lg font-semibold mb-2 text-rpg-subtext">Seviye</h3>
                <p id="level" class="text-3xl font-bold text-rpg-accent">1</p>
            </div>
             <div class="bg-rpg-card rounded-xl p-5 shadow-md text-center border border-rpg-border">
                <h3 class="text-lg font-semibold mb-2 text-rpg-subtext">Toplam XP</h3>
                <p id="xpCount" class="text-3xl font-bold text-rpg-accent">0</p>
                 <div class="w-full bg-rpg-progress-bg rounded-full h-2.5 mt-2">
                    <div id="xpBar" class="bg-rpg-accent h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
                <p id="xpNextLevel" class="text-xs text-rpg-subtext mt-1">Sonraki seviye için: 100 XP</p>
            </div>
             <div class="bg-rpg-card rounded-xl p-5 shadow-md text-center border border-rpg-border">
                <h3 class="text-lg font-semibold mb-2 text-rpg-subtext">Günlük Seri</h3>
                 <p id="streakCount" class="text-3xl font-bold text-rpg-streak">
                    <i class="fas fa-fire"></i> 0
                </p>
                 <p class="text-xs text-rpg-subtext mt-1">Gün</p>
            </div>
            <div class="bg-rpg-card rounded-xl p-5 shadow-md text-center border border-rpg-border">
                <h3 class="text-lg font-semibold mb-2 text-rpg-subtext">Rozetler</h3>
                <div class="flex justify-center items-center space-x-2 min-h-[40px]" id="badges">
                    <span class="text-rpg-subtext text-sm">Henüz rozet yok</span>
                </div>
            </div>
        </section>

        <section class="bg-rpg-card rounded-xl p-5 shadow-md mb-8 border border-rpg-border">
            <h3 class="text-xl font-semibold mb-4 text-rpg-accent border-b border-rpg-border pb-2">Yetenekler (Bu Ay)</h3>
             <div id="statBars" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-4">
                 <p class="text-rpg-subtext text-sm italic">Yükleniyor...</p>
            </div>
        </section>

        <section class="bg-rpg-card rounded-xl p-5 shadow-md mb-8 border border-rpg-border">
            <h3 class="text-xl font-semibold mb-4 text-rpg-accent border-b border-rpg-border pb-2">Aylık İstatistikler</h3>
            <div id="chartContainer" class="mb-6">
                <canvas id="activityChart"></canvas>
            </div>
            <div class="overflow-x-auto">
                 <table class="w-full min-w-[400px] text-sm text-left text-rpg-subtext">
                    <thead class="text-xs text-rpg-text uppercase bg-gray-700">
                        <tr>
                            <th scope="col" class="px-6 py-3 rounded-tl-lg">Tarih</th>
                            <th scope="col" class="px-6 py-3">Fiziksel</th>
                            <th scope="col" class="px-6 py-3 rounded-tr-lg">Zihinsel</th>
                        </tr>
                    </thead>
                    <tbody id="log" class="[&>*:nth-child(odd)]:bg-rpg-card [&>*:nth-child(even)]:bg-gray-700">
                        <tr class="border-b border-rpg-border">
                            <td colspan="3" class="px-6 py-4 text-center">Henüz kayıt yok.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="bg-rpg-card rounded-xl p-5 shadow-md border border-rpg-border mb-8">
             <h3 class="text-xl font-semibold mb-4 text-rpg-accent border-b border-rpg-border pb-2">Yeni Görev Ekle</h3>
             <form id="addTaskForm" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4 items-end">
                 <div>
                     <label for="taskName" class="form-label">Görev Adı</label>
                     <input type="text" id="taskName" name="taskName" class="form-input" required placeholder="Örn: Kitap Oku">
                 </div>
                 <div>
                     <label for="taskXp" class="form-label">XP Değeri</label>
                     <input type="number" id="taskXp" name="taskXp" class="form-input" required min="1" placeholder="Örn: 15">
                 </div>
                 <div>
                     <label for="taskStat" class="form-label">Yetenek</label>
                     <select id="taskStat" name="taskStat" class="form-select" required>
                         <option value="">Seçiniz...</option>
                     </select>
                 </div>
                 <div>
                     <label for="taskType" class="form-label">Tür</label>
                     <select id="taskType" name="taskType" class="form-select" required>
                         <option value="">Seçiniz...</option>
                         <option value="fiziksel">Fiziksel</option>
                         <option value="zihinsel">Zihinsel</option>
                     </select>
                 </div>
                 <button type="submit" class="btn btn-primary h-10 md:mt-0 mt-4">
                     <i class="fas fa-plus mr-1"></i> Ekle
                 </button>
             </form>
        </section>

        <section class="text-center">
            <button id="resetButton" class="btn btn-danger">
                <i class="fas fa-trash-alt mr-1"></i> Tüm Verileri Sıfırla
            </button>
        </section>

    </main>

    <div id="confirmationModal" class="modal opacity-0 pointer-events-none" aria-labelledby="modal-title" role="role" aria-modal="true">
        <div class="modal-content transform scale-95 transition-transform duration-300 ease-out">
            <h3 class="text-lg font-semibold text-rpg-accent mb-4" id="modal-title">Emin misiniz?</h3>
            <p class="text-sm text-rpg-subtext mb-6" id="modal-message">Bu işlem geri alınamaz. Tüm ilerlemeniz ve görevleriniz kalıcı olarak silinecektir.</p>
            <div class="flex justify-end space-x-3">
                <button id="modalCancelButton" class="btn btn-secondary">İptal</button>
                <button id="modalConfirmButton" class="btn btn-danger">Evet, Sıfırla</button>
            </div>
        </div>
    </div>

    <div id="messageModal" class="modal opacity-0 pointer-events-none" aria-labelledby="message-modal-title" role="role" aria-modal="true">
        <div class="modal-content transform scale-95 transition-transform duration-300 ease-out">
            <h3 class="text-lg font-semibold text-rpg-accent mb-4" id="message-modal-title">Bilgi</h3>
            <p class="text-sm text-rpg-subtext mb-6" id="message-modal-message"></p>
            <div class="flex justify-end">
                <button id="messageModalCloseButton" class="btn btn-secondary">Tamam</button>
            </div>
        </div>
    </div>


    <script>
        // --- Sabitler ve Ayarlar ---
        const LOCAL_STORAGE_KEYS = {
            xp: 'rpg_xp_v4', // Sürüm güncellendi
            history: 'rpg_history_v4',
            tasks: 'rpg_tasks_v4',
            stats: 'rpg_stats_v4',
            customTasks: 'rpg_customTasks_v4',
            lastCompletionDate: 'rpg_lastCompletionDate_v4',
            streak: 'rpg_streak_v4',
            lastStatResetMonth: 'rpg_lastStatResetMonth_v4' // Aylık sıfırlama takibi için yeni anahtar
        };

        // Google Drive için dosya adı
        const DRIVE_FILE_NAME = 'apex_fusion_save_data.json';
        let driveFileId = null; // Drive'daki dosyanın ID'si

        // Bir aylık hedeflere uygun yeni seviye eşikleri
        const LEVEL_THRESHOLDS = [0, 500, 1500, 3000, 5000, 7500, 10000, 13000];

        // Bir aylık hedeflere uygun yeni rozetler, XP eşikleri ve Rütbeler
        const BADGES = [
            { xp: 500, icon: '🥈', name: 'Yol Haritası Çizer', rank: 'Başlangıç' }, // Seviye 2 için
            { xp: 1500, icon: '🥇', name: 'Zihin Kalesinin Mimarı', rank: 'Yükseliş' }, // Seviye 3 için
            { xp: 3000, icon: '💎', name: 'Potansiyel Geliştirici', rank: 'Ustalık' }, // Seviye 4 için
            { xp: 5000, icon: '🏆', name: 'Strateji Ustası Adayı', rank: 'Kahramanlık' }, // Seviye 5 için
            { xp: 7500, icon: '🌟', name: 'İçsel Usta', rank: 'Efsanevi' }, // Seviye 6 için
            { xp: 13000, icon: '✨', name: 'Gerçeklik Simyacısı', rank: 'Gerçeklik' }, // Seviye 8 için
        ];

        // Güncellenmiş Başlangıç Yetenekleri (Statlar)
        const INITIAL_STATS = {
            Strateji: 0,
            Bilgi: 0,
            Yaratıcılık: 0,
            Farkındalık: 0,
            Beceri: 0,
            Hareket: 0,
            Sağlık: 0,
            Beden: 0
        };

        // Sadeleştirilmiş ve güncellenmiş görev listesi
        const DEFAULT_TASKS = [
            // Zihinsel Gelişim
            // Strateji
            { id: 'z1', name: 'Sudoku Çöz (Orta/Zor)', xp: 20, stat: 'Strateji', type: 'zihinsel' },
            { id: 'z2', name: 'Satranç Bulmacası Çöz', xp: 20, stat: 'Strateji', type: 'zihinsel' }, // Günlük en az 1 adet
            { id: 'z3', name: 'Strateji Analizi Yap', xp: 35, stat: 'Strateji', type: 'zihinsel' }, // Oyun, senaryo veya günlük plan stratejisi analizi

            // Bilgi
            { id: 'z5', name: 'Bilgilendirici İçerik Tüket (15 dk)', xp: 15, stat: 'Bilgi', type: 'zihinsel' }, // Podcast/Belgesel/Eğitim Vd.
            { id: 'z7', name: 'Kısa Araştırma Yap', xp: 20, stat: 'Bilgi', type: 'zihinsel' }, // Genel kültür veya bilgi teyidi

            // Yaratıcılık
            { id: 'z9', name: 'Objenin Yaratıcı Kullanım Alanlarını Düşün (En az 3)', xp: 20, stat: 'Yaratıcılık', type: 'zihinsel' },
            { id: 'z10', name: 'İki Alakasız Kavramı Birleştirip Fikir Üret', xp: 25, stat: 'Yaratıcılık', type: 'zihinsel' },

            // Farkındalık
            { id: 'z12', name: 'Günlük Olay/Duygu Yansıtma Yaz', xp: 15, stat: 'Farkındalık', type: 'zihinsel' }, // En az 2 cümle
            { id: 'z13', name: 'Yaptığın Bir Hatayı Analiz Et', xp: 20, stat: 'Farkındalık', type: 'zihinsel' }, // Ve bundan ders çıkar

            // Beceri
            { id: 'z14', name: 'Yeni Küçük Pratik Beceri Öğren/Pratik Yap (15-20 dk)', xp: 30, stat: 'Beceri', type: 'zihinsel' },
            { id: 'z16', name: 'El Becerisi Gerektiren Bir Ş şey Yap', xp: 20, stat: 'Beceri', type: 'zihinsel' }, // Origami, basit çizim vb.

            // Fiziksel Gelişim
            // Hareket
            { id: 'f3', name: 'Günlük Egzersiz Yap (20-30 dk)', xp: 25, stat: 'Hareket', type: 'fiziksel' }, // Vücut ağırlığı, kardiyo veya sabah koşusu dahil

            // Sağlık
            { id: 'f4', name: 'Yeterli Su Miktarını İç', xp: 10, stat: 'Sağlık', type: 'fiziksel' }, // Günlük hedef
            { id: 'f11', name: 'Günlük Cilt Bakımı Yap', xp: 10, stat: 'Sağlık', type: 'fiziksel' }, // Yeni görev eklendi

            // Beden
            { id: 'f8', name: 'Nefese Odaklan (5 dk)', xp: 10, stat: 'Beden', type: 'fiziksel' }, // Nefes egzersizi
        ];


        // --- DOM Elementleri ---
        const elements = {
            physicalTasksContainer: document.getElementById('physicalTasks'),
            mentalTasksContainer: document.getElementById('mentalTasks'),
            addTaskForm: document.getElementById('addTaskForm'),
            taskStatSelect: document.getElementById('taskStat'),
            doneCount: document.getElementById('doneCount'),
            level: document.getElementById('level'),
            xpCount: document.getElementById('xpCount'),
            xpBar: document.getElementById('xpBar'),
            xpNextLevel: document.getElementById('xpNextLevel'),
            streakCount: document.getElementById('streakCount'),
            badges: document.getElementById('badges'),
            statBars: document.getElementById('statBars'),
            logTbody: document.getElementById('log'),
            chartCanvas: document.getElementById('activityChart'),
            resetButton: document.getElementById('resetButton'),
            confirmationModal: document.getElementById('confirmationModal'),
            modalCancelButton: document.getElementById('modalCancelButton'),
            modalConfirmButton: document.getElementById('modalConfirmButton'),
            messageModal: document.getElementById('messageModal'), // Yeni mesaj kutusu modalı
            messageModalTitle: document.getElementById('message-modal-title'),
            messageModalMessage: document.getElementById('message-modal-message'),
            messageModalCloseButton: document.getElementById('messageModalCloseButton'),
            authStatus: document.getElementById('authStatus'), // Google Auth durumu
            signOutButton: document.getElementById('signOutButton'), // Çıkış butonu
            saveToDriveButton: document.getElementById('saveToDriveButton'), // Kaydet butonu
            loadFromDriveButton: document.getElementById('loadFromDriveButton'), // Yükle butonu
        };

        // --- Uygulama Durumu (State) ---
        let state = {
            xp: 0,
            history: {},
            tasks: {}, // Tamamlanan görevlerin ID'lerini tutar
            stats: { ...INITIAL_STATS }, // Bu aydaki yetenek ilerlemesini tutar
            customTasks: [], // Kullanıcı tarafından eklenen görevler
            lastCompletionDate: null, // Seri takibi için son tamamlama tarihi (ISO formatında)
            streak: 0, // Günlük seri sayısı
            lastStatResetMonth: null // Son stat sıfırlama ayını tutar (YYYY-MM formatında)
        };

        // --- Google API ve Kimlik Doğrulama ---
        let googleUser; // Google kimlik doğrulama objesi

        // Google Sign-In tamamlandığında çağrılır
        function handleCredentialResponse(response) {
            // Kimlik doğrulama başarılı olduğunda burası çalışır
            const idToken = response.credential;
            // Burada idToken'ı kullanarak kullanıcı bilgilerini alabiliriz,
            // ancak Drive API için sadece kimlik doğrulama yeterli.
            console.log("Google Sign-In Başarılı.");
            elements.authStatus.textContent = "Google Drive'a bağlanılıyor..."; // Bağlanma durumu güncellendi
            elements.signOutButton.classList.remove('hidden'); // Çıkış butonunu göster
             // Kaydet ve Yükle butonları hala devre dışı kalmalı, API hazır olunca etkinleşecek

            // Google API istemcisini başlat
            gapi.load('client', initializeGapiClient);
        }

        // Google API istemcisini başlat
        async function initializeGapiClient() {
             try {
                 // Client ID'niz ve Scope'unuz burada
                 await gapi.client.init({
                    clientId: '755451034699-ir2d9cjv9ngsckqd14np3citeqnmlrjs.apps.googleusercontent.com',
                    scope: 'https://www.googleapis.com/auth/drive.appdata' // Uygulama verileri için scope
                 });
                 console.log("Google API istemcisi başlatıldı.");

                 // API'nin yüklendiğinden ve Drive hizmetinin erişilebilir olduğundan emin ol
                 if (gapi.client && gapi.client.drive) {
                      console.log("Google Drive API yüklendi ve erişilebilir.");
                      elements.authStatus.textContent = "Google Drive'a bağlı."; // Bağlantı başarılı mesajı
                      // API hazır olduğunda Kaydet ve Yükle butonlarını etkinleştir
                      elements.saveToDriveButton.disabled = false;
                      elements.loadFromDriveButton.disabled = false;

                      // Kullanıcı oturum açtıysa Drive dosyasını ara
                      findOrCreateDriveFile();
                 } else {
                     console.error("Google Drive API yüklenemedi veya erişilebilir değil.");
                     elements.authStatus.textContent = "Google Drive bağlantısı başarısız."; // Bağlantı hatası mesajı
                     showMessage("Hata", "Google Drive API yüklenemedi. Lütfen tarayıcı konsolunu kontrol edin.");
                 }

             } catch (error) {
                 console.error("Google API istemcisi başlatılırken hata:", error);
                 elements.authStatus.textContent = "Google Drive bağlantısı başarısız."; // Bağlantı hatası mesajı
                 showMessage("Hata", "Google API başlatılırken bir sorun oluştu. Lütfen tekrar deneyin veya tarayıcı konsolunu kontrol edin.");
             }
        }

        // Çıkış yap butonu handler'ı
        function handleSignOut() {
            // GIS'in oturumu kapatma fonksiyonunu kullan
            google.accounts.id.disableAutoSelect(); // Otomatik giriş özelliğini devre dışı bırak
            // googleUser objesi GIS ile doğrudan kullanılmayabilir,
            // GIS'in kendi çıkış mekanizması kullanılır.
            // GIS ile çıkış genellikle sadece çerezleri temizler,
            // uygulamanın durumunu sıfırlamak gerekebilir.

            console.log('Oturum kapatıldı (GIS).');
            elements.authStatus.textContent = "Google Drive bağlantısı kesildi.";
            elements.signOutButton.classList.add('hidden'); // Çıkış butonunu gizle
            // Kaydet ve Yükle butonlarını devre dışı bırak
            elements.saveToDriveButton.disabled = true;
            elements.loadFromDriveButton.disabled = true;
            driveFileId = null; // Dosya ID'sini sıfırla

            // İsteğe bağlı: Uygulama durumunu sıfırlamak isterseniz
            // resetAppState(); // Uygulama durumunu sıfırlayan bir fonksiyon çağırabilirsiniz
        }

        // Google API hazır olduğunda çağrılır (bu fonksiyon gapi.js yüklendiğinde otomatik çağrılır)
        function gapiLoaded() {
            console.log("Google API (gapi.js) yüklendi.");
            // gapi.client modülünü yükle
            // gapi.load('client', initializeGapiClient); // Bu çağrı handleCredentialResponse içinde yapılıyor
        }

        // Google Identity Services (GIS) yüklendiğinde çağrılır (bu fonksiyon gsi/client.js yüklendiğinde otomatik çağrılır)
        function gisLoaded() {
            console.log("Google Identity Services (GIS) yüklendi.");
             // GIS otomatik olarak data-callback ile handleCredentialResponse'u çağıracaktır.
             // Ek GIS konfigürasyonu burada yapılabilir.
        }


        // --- Google Drive İşlemleri ---

        // Drive'daki kaydedilmiş dosyayı arar veya oluşturur
        async function findOrCreateDriveFile() {
            if (!gapi.client || !gapi.client.drive) {
                 console.error("findOrCreateDriveFile: Google Drive API hazır değil.");
                 return;
            }
            try {
                // Uygulama verileri klasöründe dosyayı ara
                const response = await gapi.client.drive.files.list({
                    q: `name='${DRIVE_FILE_NAME}' and 'appDataFolder' in parents`,
                    spaces: 'appDataFolder',
                    fields: 'files(id, name)',
                    pageSize: 1
                });

                const files = response.result.files;
                if (files && files.length > 0) {
                    // Dosya bulundu
                    driveFileId = files[0].id;
                    console.log("Drive dosyası bulundu:", driveFileId);
                     showMessage("Bilgi", "Google Drive'da kaydedilmiş veri bulundu.");
                } else {
                    // Dosya bulunamadı, yeni dosya oluştur
                    console.log("Drive dosyası bulunamadı, oluşturuluyor...");
                    await createInitialDriveFile(); // Boş veya başlangıç verisiyle dosya oluştur
                    showMessage("Bilgi", "Google Drive'da yeni bir kayıt dosyası oluşturuldu.");
                }
            } catch (error) {
                console.error("Drive dosyası aranırken/oluşturulurken hata:", error);
                // Hata durumunda butonları devre dışı bırakmak mantıklı olabilir
                elements.saveToDriveButton.disabled = true;
                elements.loadFromDriveButton.disabled = true;
                showMessage("Hata", "Google Drive dosyasına erişilemedi veya oluşturulamadı. Lütfen tekrar deneyin veya konsolu kontrol edin.");
            }
        }

        // Başlangıç (boş) Drive dosyası oluşturur
        async function createInitialDriveFile() {
             if (!gapi.client || !gapi.client.drive) {
                 console.error("createInitialDriveFile: Google Drive API hazır değil.");
                 throw new Error("Drive API not ready"); // Hatanın yayılmasını sağla
            }
             try {
                const fileMetadata = {
                    'name': DRIVE_FILE_NAME,
                    'parents': ['appDataFolder'] // Uygulama verileri klasörüne kaydet
                };
                const media = {
                    mimeType: 'application/json',
                    body: JSON.stringify({}) // Boş JSON objesi ile başla
                };
                const response = await gapi.client.drive.files.create({
                    resource: fileMetadata,
                    media: media,
                    fields: 'id'
                });
                driveFileId = response.result.id;
                console.log("Başlangıç Drive dosyası oluşturuldu:", driveFileId);
            } catch (error) {
                console.error("Başlangıç Drive dosyası oluşturulurken hata:", error);
                showMessage("Hata", "Google Drive'da başlangıç dosyası oluşturulamadı.");
                throw error; // Hatanın yayılmasını sağla
            }
        }


        // Mevcut durumu Google Drive'a kaydeder
        async function saveToDrive() {
             if (!gapi.client || !gapi.client.drive || !driveFileId) {
                 showMessage("Hata", "Google Drive API hazır değil veya dosya ID'si bulunamadı.");
                 return;
             }

             try {
                 const fileContent = JSON.stringify(state); // Uygulama durumunu JSON stringine çevir
                 const response = await gapi.client.request({
                    path: '/upload/drive/v3/files/' + driveFileId,
                    method: 'PATCH', // Dosyayı güncellemek için PATCH kullanılır
                    params: {
                        uploadType: 'media'
                    },
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: fileContent
                 });
                 console.log("Durum Drive'a kaydedildi:", response);
                 showMessage("Başarılı", "Veriler Google Drive'a başarıyla kaydedildi.");
             } catch (error) {
                 console.error("Durum Drive'a kaydedilirken hata:", error);
                 showMessage("Hata", "Veriler Google Drive'a kaydedilemedi. Lütfen tekrar deneyin.");
             }
        }

        // Google Drive'dan durumu yükler
        async function loadFromDrive() {
            if (!gapi.client || !gapi.client.drive || !driveFileId) {
                 showMessage("Hata", "Google Drive API hazır değil veya dosya ID'si bulunamadı.");
                 return;
             }

             try {
                 const response = await gapi.client.drive.files.get({
                    fileId: driveFileId,
                    alt: 'media' // Dosya içeriğini almak için 'media' kullanılır
                 });

                 const loadedState = response.result; // Yüklenen veri (JSON objesi olarak gelir)

                 // Yüklenen veriyi uygulama durumuna uygula
                 // Yüklenen verinin yapısını kontrol etmek iyi bir pratiktir.
                 if (loadedState && typeof loadedState === 'object') {
                     // Mevcut state objesi üzerine yüklenen veriyi yayarak uygula
                     // Bu, yeni eklenen anahtarların da yüklenmesini sağlar.
                     state = { ...state, ...loadedState };
                     saveState(); // Yüklenen durumu localStorage'a da kaydet
                     renderAll(); // UI'ı yüklenen durumla yeniden çiz
                     console.log("Durum Drive'dan yüklendi:", state);
                     showMessage("Başarılı", "Veriler Google Drive'dan başarıyla yüklendi.");
                 } else {
                     console.error("Yüklenen veri formatı hatalı:", loadedState);
                     showMessage("Hata", "Google Drive'dan yüklenen veri formatı geçerli değil.");
                 }

             } catch (error) {
                 console.error("Durum Drive'dan yüklenirken hata:", error);
                 showMessage("Hata", "Veriler Google Drive'dan yüklenemedi veya dosya boş/bozuk. Lütfen tekrar deneyin.");
             }
        }


        // --- Chart.js Kurulumu ---
        let activityChart;
        function initializeChart() {
             if (activityChart) activityChart.destroy(); // Eğer grafik zaten varsa yok et
             const ctx = elements.chartCanvas.getContext('2d');
             activityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [], // Tarihler burada olacak
                    datasets: [
                        {
                            label: 'Fiziksel Görev',
                            data: [], // Fiziksel görev sayıları
                            backgroundColor: tailwind.config.theme.extend.colors['rpg-physical'],
                            borderColor: tailwind.config.theme.extend.colors['rpg-accent'],
                            borderWidth: 1,
                            borderRadius: 5,
                        },
                        {
                            label: 'Zihinsel Görev',
                            data: [], // Zihinsel görev sayıları
                            backgroundColor: tailwind.config.theme.extend.colors['rpg-mental'],
                            borderColor: 'rgba(0, 206, 209, 1)', // Zihinsel için belirgin bir renk
                            borderWidth: 1,
                            borderRadius: 5,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Konteyner boyutuna uyum sağlar
                    scales: {
                        y: {
                            beginAtZero: true,
                            // stepSize: 1 kaldırıldı, çünkü artık yüzde gösteriliyor
                            ticks: {
                                color: tailwind.config.theme.extend.colors['rpg-subtext'],
                                // Y ekseninde yüzde işaretini göster
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: { color: tailwind.config.theme.extend.colors['rpg-border'] }
                        },
                        x: {
                            ticks: { color: tailwind.config.theme.extend.colors['rpg-subtext'] },
                            grid: { display: false } // X ekseni grid çizgilerini gizle
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top', // Legend üstte
                            labels: {
                                color: tailwind.config.theme.extend.colors['rpg-text'],
                                boxWidth: 12,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: tailwind.config.theme.extend.colors['rpg-card'],
                            titleColor: tailwind.config.theme.extend.colors['rpg-accent'],
                            bodyColor: tailwind.config.theme.extend.colors['rpg-text'],
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += context.parsed.y + '%'; // Görev sayısı yerine yüzde göster
                                    return label;
                                }
                            }
                        }
                    }
                }
             });
        }

        // --- Yardımcı Fonksiyonlar ---
        const todayKey = () => new Date().toLocaleDateString('tr-TR'); // DD.MM.YYYY formatında
        const todayIsoDate = () => new Date().toISOString().split('T')[0]; //YYYY-MM-DD formatında

        // Mevcut 
